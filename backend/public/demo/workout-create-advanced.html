<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crear Sesi√≥n - COACHING</title>
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;600;700&family=Work+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        :root {
            --primary:#FF6B35; --dark:#1A1A2E; --dark-light:#16213E;
            --card-bg:rgba(255,255,255,0.05); --card-border:rgba(255,255,255,0.1);
            --success:#10b981; --danger:#ef4444; --text-muted:#94a3b8; --text-main:#e2e8f0;
        }
        body { font-family:'Work Sans',sans-serif; background:linear-gradient(135deg,var(--dark) 0%,var(--dark-light) 100%); min-height:100vh; color:var(--text-main); padding:2rem; }
        
        .container { max-width:1400px; margin:0 auto; }
        .header { display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem; }
        h1 { font-family:'Oswald',sans-serif; font-size:2rem; color:var(--primary); }
        .back-btn { background:none; border:1px solid var(--card-border); color:var(--text-muted); padding:0.6rem 1.2rem; border-radius:8px; cursor:pointer; text-decoration:none; }
        .back-btn:hover { border-color:var(--primary); color:var(--primary); }
        
        .form-grid { display:grid; grid-template-columns:1.2fr 1fr; gap:2rem; }
        
        .form-section { background:var(--card-bg); border:1px solid var(--card-border); border-radius:14px; padding:1.5rem; margin-bottom:1.5rem; }
        .section-title { font-family:'Oswald',sans-serif; font-size:1.2rem; margin-bottom:1rem; color:var(--primary); }
        
        .form-group { margin-bottom:1rem; }
        label { display:block; margin-bottom:0.5rem; font-size:0.85rem; color:var(--text-muted); font-weight:500; }
        input, select, textarea { width:100%; padding:0.7rem; background:rgba(0,0,0,0.2); border:1px solid var(--card-border); border-radius:8px; color:var(--text-main); font-family:inherit; font-size:0.9rem; }
        input:focus, select:focus, textarea:focus { outline:none; border-color:var(--primary); }
        textarea { resize:vertical; min-height:100px; font-family:'Courier New', monospace; font-size:0.85rem; }
        
        .section-card { background:rgba(0,0,0,0.2); border:1px solid var(--card-border); border-radius:10px; padding:1.25rem; margin-bottom:1rem; position:relative; }
        .section-header { display:flex; gap:1rem; align-items:center; margin-bottom:1rem; padding-bottom:1rem; border-bottom:1px solid var(--card-border); }
        .section-letter { width:40px; height:40px; border-radius:50%; background:var(--primary); color:#fff; display:flex; align-items:center; justify-content:center; font-family:'Oswald',sans-serif; font-size:1.2rem; font-weight:700; flex-shrink:0; }
        .section-name-input { flex:1; background:rgba(0,0,0,0.3); border:1px solid var(--card-border); border-radius:6px; padding:0.6rem; color:var(--text-main); font-weight:600; }
        
        .btn-remove { position:absolute; top:1rem; right:1rem; width:28px; height:28px; border:none; border-radius:6px; background:rgba(239,68,68,0.15); color:var(--danger); cursor:pointer; font-size:0.9rem; transition:all 0.2s; }
        .btn-remove:hover { background:rgba(239,68,68,0.25); }
        
        .type-specific { background:rgba(59,130,246,0.05); border:1px solid rgba(59,130,246,0.2); border-radius:8px; padding:1rem; margin-top:1rem; }
        .type-info { font-size:0.8rem; color:#93c5fd; margin-bottom:0.75rem; font-style:italic; }
        
        .btn { padding:0.75rem 1.5rem; border:none; border-radius:8px; font-weight:600; cursor:pointer; transition:all 0.2s; font-family:inherit; font-size:0.95rem; }
        .btn-primary { background:var(--primary); color:#fff; }
        .btn-primary:hover { background:#e05a24; }
        .btn-secondary { background:var(--card-bg); color:var(--text-muted); border:1px solid var(--card-border); }
        .btn-secondary:hover { border-color:var(--primary); color:var(--primary); }
        .btn-add-section { width:100%; }
        
        .actions { display:flex; gap:1rem; margin-top:2rem; }
        .actions .btn { flex:1; }
        
        .preview { position:sticky; top:2rem; }
        .preview-section { background:#f8f9fa; border:1px solid #e0e0e0; border-radius:10px; padding:1rem; margin-bottom:0.75rem; }
        .preview-letter { width:32px; height:32px; border-radius:50%; background:#2c3e50; color:#fff; display:inline-flex; align-items:center; justify-content:center; font-weight:700; margin-right:0.75rem; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div>
            <h1>Crear Nueva Sesi√≥n</h1>
        </div>
        <a href="workouts.html" class="back-btn">‚Üê Volver</a>
    </div>

    <div class="form-grid">
        <div class="form-left">
            <!-- Notas del Coach -->
            <div class="form-section">
                <div class="section-title">üìù Notas del Coach</div>
                <div class="form-group">
                    <textarea id="coachNotes" placeholder="Instrucciones para esta sesi√≥n..."></textarea>
                </div>
            </div>

            <!-- Secciones -->
            <div class="form-section">
                <div class="section-title">üèãÔ∏è Secciones (A, B, C...)</div>
                <div id="sectionsContainer"></div>
                <button class="btn btn-secondary btn-add-section" onclick="addSection()">+ Agregar Secci√≥n</button>
            </div>

            <div class="actions">
                <button class="btn btn-secondary" onclick="window.location='workouts.html'">Cancelar</button>
                <button class="btn btn-primary" onclick="saveSession()">üíæ Guardar Sesi√≥n</button>
            </div>
        </div>

        <div class="form-right">
            <div class="form-section preview">
                <div class="section-title">üëÅÔ∏è Vista Previa</div>
                <div id="previewContent" style="max-height:70vh;overflow-y:auto;"></div>
            </div>
        </div>
    </div>
</div>

<script>
const API_URL = 'http://localhost:8000/api/v1';
const authToken = localStorage.getItem('authToken');
if (!authToken) window.location.href = 'login-connected.html';

let sections = [];
const letters = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J'];

const sectionTypes = {
    warmup: { name: 'Warm-up', fields: [] },
    cooldown: { name: 'Cool-down', fields: [] },
    amrap: { name: 'AMRAP', fields: ['time_cap'], info: 'As Many Rounds As Possible en tiempo determinado' },
    for_time: { name: 'For Time', fields: ['time_cap'], info: 'Completar en el menor tiempo posible' },
    emom: { name: 'EMOM', fields: ['duration', 'pattern'], info: 'Every Minute on the Minute' },
    tabata: { name: 'Tabata', fields: ['work_sec', 'rest_sec', 'rounds'], info: 'Intervalos de alta intensidad' },
    chipper: { name: 'Chipper', fields: ['time_cap'], info: 'Lista larga de ejercicios con altas reps' },
    strength: { name: 'Strength', fields: ['sets', 'reps'], info: 'Trabajo de fuerza' },
    skill: { name: 'Skill', fields: ['duration'], info: 'Pr√°ctica de t√©cnica' },
    custom: { name: 'Custom', fields: [] }
};

document.addEventListener('input', updatePreview);

function addSection() {
    sections.push({
        id: Date.now(),
        name: '',
        type: 'warmup',
        content: '',
        videoUrl: '',
        params: {},
        isBenchmark: false,
        isHero: false
    });
    renderSections();
    updatePreview();
}

function removeSection(index) {
    if (confirm('¬øEliminar secci√≥n?')) {
        sections.splice(index, 1);
        renderSections();
        updatePreview();
    }
}

function updateSectionType(index, type) {
    sections[index].type = type;
    sections[index].params = {};
    renderSections();
    updatePreview();
}

function renderSections() {
    const container = document.getElementById('sectionsContainer');
    container.innerHTML = sections.map((section, idx) => {
        const typeData = sectionTypes[section.type];
        return `
            <div class="section-card">
                <button class="btn-remove" onclick="removeSection(${idx})">‚úï</button>
                <div class="section-header">
                    <div class="section-letter">${letters[idx]}</div>
                    <input type="text" class="section-name-input" placeholder="Nombre de la secci√≥n" 
                           value="${section.name}" onchange="sections[${idx}].name = this.value; updatePreview()">
                </div>
                
                <div class="form-group">
                    <label>Tipo de Secci√≥n</label>
                    <select onchange="updateSectionType(${idx}, this.value)" style="font-weight:600;">
                        <optgroup label="Estructura">
                            <option value="warmup" ${section.type==='warmup'?'selected':''}>Warm-up</option>
                            <option value="cooldown" ${section.type==='cooldown'?'selected':''}>Cool-down</option>
                            <option value="skill" ${section.type==='skill'?'selected':''}>Skill Work</option>
                            <option value="strength" ${section.type==='strength'?'selected':''}>Strength</option>
                        </optgroup>
                        <optgroup label="MetCon">
                            <option value="amrap" ${section.type==='amrap'?'selected':''}>AMRAP</option>
                            <option value="for_time" ${section.type==='for_time'?'selected':''}>For Time</option>
                            <option value="emom" ${section.type==='emom'?'selected':''}>EMOM</option>
                            <option value="tabata" ${section.type==='tabata'?'selected':''}>Tabata</option>
                            <option value="chipper" ${section.type==='chipper'?'selected':''}>Chipper</option>
                        </optgroup>
                        <option value="custom" ${section.type==='custom'?'selected':''}>Custom</option>
                    </select>
                </div>
                
                ${renderTypeSpecificFields(idx, section.type)}
                
                <div class="form-group">
                    <label>Contenido / Ejercicios</label>
                    <textarea onchange="sections[${idx}].content = this.value; updatePreview()"
                              placeholder="15 Front Squat 95#
30 Toes to Bar
15 Thrusters 95#
rest 1 min">${section.content}</textarea>
                </div>
                
                <div class="form-group">
                    <label>URL Video Demo (opcional)</label>
                    <input type="text" value="${section.videoUrl}" 
                           onchange="sections[${idx}].videoUrl = this.value">
                </div>
                
                <div style="display:flex;gap:1.5rem;margin-top:1rem;padding-top:1rem;border-top:1px solid var(--card-border);">
                    <label style="display:flex;align-items:center;gap:0.5rem;cursor:pointer;font-size:0.85rem;">
                        <input type="checkbox" ${section.isBenchmark?'checked':''} style="width:auto;" 
                               onchange="sections[${idx}].isBenchmark = this.checked; updatePreview()">
                        <span>üìä Benchmark</span>
                    </label>
                    <label style="display:flex;align-items:center;gap:0.5rem;cursor:pointer;font-size:0.85rem;">
                        <input type="checkbox" ${section.isHero?'checked':''} style="width:auto;" 
                               onchange="sections[${idx}].isHero = this.checked; updatePreview()">
                        <span>üéñÔ∏è Hero WOD</span>
                    </label>
                </div>
            </div>
        `;
    }).join('');
}

function renderTypeSpecificFields(idx, type) {
    const typeData = sectionTypes[type];
    if (!typeData.fields || typeData.fields.length === 0) return '';
    
    let html = '<div class="type-specific">';
    if (typeData.info) {
        html += `<div class="type-info">‚ÑπÔ∏è ${typeData.info}</div>`;
    }
    
    typeData.fields.forEach(field => {
        const fieldTemplates = {
            time_cap: `<div class="form-group"><label>Time Cap (minutos)</label><input type="number" value="${sections[idx].params.time_cap||''}" onchange="sections[${idx}].params.time_cap = this.value; updatePreview()"></div>`,
            rounds: `<div class="form-group"><label>Rondas</label><input type="number" value="${sections[idx].params.rounds||''}" onchange="sections[${idx}].params.rounds = this.value; updatePreview()"></div>`,
            duration: `<div class="form-group"><label>Duraci√≥n (minutos)</label><input type="number" value="${sections[idx].params.duration||''}" onchange="sections[${idx}].params.duration = this.value; updatePreview()"></div>`,
            pattern: `<div class="form-group"><label>Patr√≥n</label><input type="text" value="${sections[idx].params.pattern||''}" placeholder="Min 1: ..., Min 2: ..." onchange="sections[${idx}].params.pattern = this.value; updatePreview()"></div>`,
            sets: `<div class="form-group"><label>Sets</label><input type="number" value="${sections[idx].params.sets||''}" onchange="sections[${idx}].params.sets = this.value; updatePreview()"></div>`,
            reps: `<div class="form-group"><label>Esquema Reps</label><input type="text" value="${sections[idx].params.reps||''}" placeholder="5-5-5-5-5" onchange="sections[${idx}].params.reps = this.value; updatePreview()"></div>`,
            work_sec: `<div class="form-group"><label>Trabajo (segundos)</label><input type="number" value="${sections[idx].params.work_sec||'20'}" onchange="sections[${idx}].params.work_sec = this.value; updatePreview()"></div>`,
            rest_sec: `<div class="form-group"><label>Descanso (segundos)</label><input type="number" value="${sections[idx].params.rest_sec||'10'}" onchange="sections[${idx}].params.rest_sec = this.value; updatePreview()"></div>`
        };
        html += fieldTemplates[field] || '';
    });
    
    html += '</div>';
    return html;
}

function updatePreview() {
    const coachNotes = document.getElementById('coachNotes').value;
    let preview = '';
    
    if (coachNotes) {
        preview += `<div style="background:rgba(255,107,53,0.1);border:1px solid rgba(255,107,53,0.3);border-radius:10px;padding:1rem;margin-bottom:1rem;color:#2c3e50;">
            <strong>üìù Notas del Coach:</strong><br><span style="white-space:pre-wrap;">${coachNotes}</span>
        </div>`;
    }
    
    sections.forEach((section, idx) => {
        const typeData = sectionTypes[section.type];
        let subtitle = typeData.name;
        
        // Construir subt√≠tulo con par√°metros
        const params = [];
        if (section.params.rounds) params.push(`${section.params.rounds} rounds`);
        if (section.params.time_cap) params.push(`Time Cap: ${section.params.time_cap} min`);
        if (section.params.duration) params.push(`${section.params.duration} min`);
        if (section.params.sets) params.push(`${section.params.sets} sets`);
        if (section.params.reps) params.push(section.params.reps);
        if (section.params.work_sec && section.params.rest_sec) {
            params.push(`${section.params.work_sec}seg trabajo / ${section.params.rest_sec}seg descanso`);
        }
        
        if (params.length > 0) subtitle += ' - ' + params.join(', ');
        
        // Badges de Benchmark/Hero por secci√≥n
        let badges = '';
        if (section.isBenchmark || section.isHero) {
            badges = '<div style="display:flex;gap:0.5rem;margin-top:0.5rem;">';
            if (section.isBenchmark) {
                badges += '<span style="background:#007bff;color:white;padding:0.2rem 0.5rem;border-radius:12px;font-size:0.7rem;font-weight:600;">üìä BENCHMARK</span>';
            }
            if (section.isHero) {
                badges += '<span style="background:#dc3545;color:white;padding:0.2rem 0.5rem;border-radius:12px;font-size:0.7rem;font-weight:600;">üéñÔ∏è HERO</span>';
            }
            badges += '</div>';
        }
        
        preview += `<div class="preview-section">
            <div style="display:flex;align-items:flex-start;margin-bottom:0.75rem;">
                <span class="preview-letter">${letters[idx]}</span>
                <div style="flex:1;">
                    <div style="font-weight:700;color:#2c3e50;">${section.name || 'Secci√≥n ' + (idx + 1)}</div>
                    <div style="font-size:0.85rem;color:#6c757d;">${subtitle}</div>
                    ${badges}
                </div>
                <div style="width:24px;height:24px;border:2px solid #ced4da;border-radius:50%;"></div>
            </div>
            <div style="color:#2c3e50;white-space:pre-wrap;line-height:1.6;font-size:0.9rem;">${section.content || '<em style="color:#adb5bd;">Sin contenido</em>'}</div>
        </div>`;
    });
    
    document.getElementById('previewContent').innerHTML = preview || '<div style="color:var(--text-muted);text-align:center;padding:2rem;">Agrega secciones</div>';
}

async function saveSession() {
    if (sections.length === 0) {
        alert('Agrega al menos una secci√≥n');
        return;
    }
    
    const today = new Date().toISOString().split('T')[0];
    
    const workout = {
        name: `Sesi√≥n ${today}`,
        workout_type: 'custom', // Tipo v√°lido del backend
        difficulty_level: 'intermediate', // Requerido por backend
        description: document.getElementById('coachNotes').value || null,
        workout_structure: {
            format: 'custom', // Valor v√°lido: for_time,amrap,emom,tabata,rounds,chipper,strength,custom,endurance,gymnastics
            sections_count: sections.length
        },
        sections: sections.map((s, idx) => ({
            name: s.name || `Secci√≥n ${letters[idx]}`,
            section_type: s.type,
            description: s.content || null,
            video_url: s.videoUrl || null,
            parameters: s.params,
            is_benchmark: s.isBenchmark || false,
            is_hero: s.isHero || false,
            order: idx
        }))
    };
    
    try {
        console.log('=== GUARDANDO WORKOUT ===');
        console.log('Datos a enviar:', JSON.stringify(workout, null, 2));
        
        const response = await fetch(`${API_URL}/workouts`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${authToken}`,
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            body: JSON.stringify(workout)
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('‚úÖ Sesi√≥n creada');
            window.location.href = 'workouts.html';
        } else {
            alert('Error: ' + (data.message || 'No se pudo crear'));
        }
    } catch (error) {
        console.error(error);
        alert('Error de conexi√≥n');
    }
}
</script>
</body>
</html>
